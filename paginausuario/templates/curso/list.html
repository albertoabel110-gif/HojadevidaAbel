{% extends 'az.html' %}

{% block title %}Cursos Realizados{% endblock %}

{% block content %}
<style>
  .table-wrap{
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
  }
  .card-header-clean{
    background:#fff;
    border-bottom:1px solid rgba(0,0,0,.06);
  }
  .table-clean{ margin-bottom:0; font-size:.92rem; }
  .table-clean thead th{
    position: sticky; top: 0; z-index: 2;
    background:#111; color:#fff; border-bottom:0;
    padding:.9rem .75rem; white-space:nowrap;
  }
  .table-clean tbody td{
    vertical-align: top;
    padding:.85rem .75rem;
    border-top:1px solid rgba(0,0,0,.06);
  }
  .table-clean tbody tr:nth-child(even){ background: rgba(0,0,0,.02); }
  .table-clean tbody tr:hover{ background: rgba(0,0,0,.04); }

  .cell-wrap{ white-space: normal !important; word-break: break-word; overflow-wrap:anywhere; }
  .col-curso{ min-width:220px; }
  .col-desc{ min-width:320px; max-width:520px; }
  .col-ent{ min-width:220px; max-width:320px; }
  .col-contacto{ min-width:200px; }
  .col-email{ min-width:240px; }
  .col-cert{ min-width:140px; }
  .col-acciones{ min-width:130px; }

  .btn-icon{
    width:38px; height:34px;
    display:inline-flex; align-items:center; justify-content:center;
    padding:0;
  }
  .badge-soft{
    background: rgba(0,0,0,.06);
    color:#222;
    font-weight:600;
  }

  /* Barra filtros */
  .filters{
    display:flex;
    flex-wrap:wrap;
    gap:.75rem;
    align-items:center;
  }
  .filters .form-control,
  .filters .form-select{
    height: 38px;
  }
  .hint{
    font-size: .85rem;
    color: #6c757d;
  }
</style>

<div class="card shadow-sm border-0">
  <div class="card-header card-header-clean d-flex flex-wrap gap-2 justify-content-between align-items-center">
    <div>
      <h3 class="mb-0">Cursos Realizados</h3>
      <small class="text-muted">Listado de cursos registrados</small>
    </div>

    <div class="d-flex align-items-center gap-2">
      <span class="badge badge-soft">Total: {{ cursos|length }}</span>

      {% if request.user.is_authenticated and request.user.is_staff %}
        <a href="{% url 'curso_create' %}" class="btn btn-dark btn-sm">‚ûï Nuevo Curso</a>
      {% endif %}
    </div>
  </div>

  <div class="card-body">

    <!-- Barra de b√∫squeda / filtros -->
    <div class="filters mb-3">
      <div class="flex-grow-1" style="min-width:260px;">
        <input id="searchInput" type="search" class="form-control"
               placeholder="üîé Buscar (curso, entidad, contacto, descripci√≥n, email, tel√©fono...)">
        <div class="hint mt-1">Tip: escribe cualquier palabra y filtra en vivo.</div>
      </div>

      <div style="min-width:180px;">
        <select id="rowsPerPage" class="form-select">
          <option value="10">Mostrar 10</option>
          <option value="25" selected>Mostrar 25</option>
          <option value="50">Mostrar 50</option>
          <option value="100">Mostrar 100</option>
          <option value="999999">Mostrar todo</option>
        </select>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge badge-soft" id="resultsCount">Mostrando 0</span>
        <button id="clearBtn" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
      </div>
    </div>

    <div class="table-wrap">
      <div class="table-responsive" style="max-height: 70vh;">
        <table class="table table-clean align-middle" id="cursosTable">
          <thead>
            <tr>
              {% if request.user.is_authenticated and request.user.is_staff %}
                <th class="text-nowrap">ID</th>
              {% endif %}
              <th class="text-nowrap col-curso">Curso</th>
              <th class="text-nowrap">Inicio</th>
              <th class="text-nowrap">Fin</th>
              <th class="text-nowrap">Horas</th>
              <th class="text-nowrap col-desc">Descripci√≥n</th>
              <th class="text-nowrap col-ent">Entidad</th>
              <th class="text-nowrap col-contacto">Contacto</th>
              <th class="text-nowrap">Tel√©fono</th>
              <th class="text-nowrap col-email">Email</th>
              <th class="text-nowrap col-cert">Certificado</th>

              {% if request.user.is_authenticated and request.user.is_staff %}
                <th class="text-end text-nowrap col-acciones">Acciones</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
            {% for c in cursos %}
            <tr>
              {% if request.user.is_authenticated and request.user.is_staff %}
                <td class="text-muted">{{ c.idcursorealizado }}</td>
              {% endif %}

              <td class="fw-semibold cell-wrap col-curso">{{ c.nombrecurso|default:"‚Äî" }}</td>
              <td class="text-nowrap">{% if c.fechainicio %}{{ c.fechainicio|date:"d M, Y" }}{% else %}‚Äî{% endif %}</td>
              <td class="text-nowrap">{% if c.fechafin %}{{ c.fechafin|date:"d M, Y" }}{% else %}‚Äî{% endif %}</td>
              <td class="text-nowrap">{% if c.totalhoras %}{{ c.totalhoras }}{% else %}‚Äî{% endif %}</td>

              <td class="cell-wrap col-desc">{{ c.descripcioncurso|default:"‚Äî" }}</td>
              <td class="cell-wrap col-ent">{{ c.entidadpatrocinadora|default:"‚Äî" }}</td>
              <td class="cell-wrap col-contacto">{{ c.nombrecontactoauspicia|default:"‚Äî" }}</td>

              <td class="text-nowrap">
                {% if c.telefonocontactoauspicia %}
                  <a href="tel:{{ c.telefonocontactoauspicia }}" class="text-decoration-none">
                    {{ c.telefonocontactoauspicia }}
                  </a>
                {% else %}‚Äî{% endif %}
              </td>

              <td class="cell-wrap col-email">
                {% if c.emailempresapatrocinadora %}
                  <a href="mailto:{{ c.emailempresapatrocinadora }}" class="text-decoration-none">
                    {{ c.emailempresapatrocinadora }}
                  </a>
                {% else %}‚Äî{% endif %}
              </td>

              {% for c in cursos %}
                <p><b>{{ c.nombrecurso }}</b></p>

                {% if c.rutacertificado %}
                  <a href="{{ c.rutacertificado.url }}" target="_blank">Ver certificado</a>
                  <br>
                  <iframe src="{{ c.rutacertificado.url }}" width="100%" height="600"></iframe>
                {% else %}
                  <span>Sin certificado</span>
                {% endif %}

                <hr>
              {% endfor %}

              {% if request.user.is_authenticated and request.user.is_staff %}
              <td class="text-end text-nowrap col-acciones">
                <a href="{% url 'curso_update' c.pk %}" class="btn btn-warning btn-sm btn-icon" title="Editar">‚úèÔ∏è</a>
                <a href="{% url 'curso_delete' c.pk %}" class="btn btn-danger btn-sm btn-icon" title="Eliminar">üóëÔ∏è</a>
              </td>
              {% endif %}
            </tr>
            {% empty %}
            <tr>
              <td colspan="12" class="text-center text-muted py-4">No hay cursos registrados</td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>

  </div>
</div>

<script>
  (function () {
    const searchInput = document.getElementById("searchInput");
    const rowsPerPage = document.getElementById("rowsPerPage");
    const clearBtn = document.getElementById("clearBtn");
    const resultsCount = document.getElementById("resultsCount");

    const table = document.getElementById("cursosTable");
    const tbody = table.querySelector("tbody");

    // Todas las filas reales (sin la fila "empty" si existe)
    let allRows = Array.from(tbody.querySelectorAll("tr"));

    function isEmptyRow(row){
      // si tu fila empty tiene un td grande con "No hay cursos..."
      return row.innerText.trim().toLowerCase().includes("no hay cursos registrados");
    }
    allRows = allRows.filter(r => !isEmptyRow(r));

    function applyFilters() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const limit = parseInt(rowsPerPage.value, 10);

      let visible = 0;

      allRows.forEach((row) => {
        const text = row.innerText.toLowerCase();
        const match = !q || text.includes(q);

        if (match && visible < limit) {
          row.style.display = "";
          visible++;
        } else {
          row.style.display = "none";
        }
      });

      resultsCount.textContent = `Mostrando ${visible} de ${allRows.filter(r => {
        const text = r.innerText.toLowerCase();
        return !q || text.includes(q);
      }).length}`;
    }

    searchInput.addEventListener("input", applyFilters);
    rowsPerPage.addEventListener("change", applyFilters);

    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      rowsPerPage.value = "25";
      applyFilters();
      searchInput.focus();
    });

    // Inicial
    applyFilters();
  })();
</script>

{% endblock %}

